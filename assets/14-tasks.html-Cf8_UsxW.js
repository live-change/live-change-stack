import{_ as e,c as n,e as a,o as t}from"./app-CdUme-sL.js";const r={};function i(o,s){return t(),n("div",null,s[0]||(s[0]=[a(`<h1 id="tasks" tabindex="-1"><a class="header-anchor" href="#tasks"><span>Tasks</span></a></h1><p>The <strong>task service</strong> (<code>@live-change/task-service</code>) runs background work that can be retried, report progress, and be observed by cause (e.g. “all tasks for this event”). Add <strong>taskService</strong> to your service <strong>use</strong> and call the exported <strong>task</strong> API to define and run tasks.</p><h2 id="dependencies" tabindex="-1"><a class="header-anchor" href="#dependencies"><span>Dependencies</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: live-change-stack/services/task-service/definition.js</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> taskService <span class="token keyword">from</span> <span class="token string">&#39;@live-change/task-service&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> definition <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createServiceDefinition</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;myService&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span> relationsPlugin<span class="token punctuation">,</span> accessControlService<span class="token punctuation">,</span> taskService <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="task-definition" tabindex="-1"><a class="header-anchor" href="#task-definition"><span>Task definition</span></a></h2><p>A task is defined by an object with <strong>name</strong>, <strong>execute</strong>, and optional <strong>expire</strong>, <strong>maxRetries</strong>, <strong>trigger</strong>, <strong>action</strong>, <strong>service</strong>:</p><ul><li><strong>name</strong> — Unique task name.</li><li><strong>execute(props, context, emit)</strong> — Async function that runs the work. <strong>context</strong> has <strong>task</strong> (id, run, progress, trigger, triggerService), <strong>trigger</strong>, <strong>triggerService</strong>, <strong>causeType</strong>, <strong>cause</strong>.</li><li><strong>expire</strong> — Optional TTL in ms; tasks older than this can be reused by hash.</li><li><strong>maxRetries</strong> — Default 5.</li><li><strong>retryDelay</strong> — Optional (retryCount) =&gt; ms.</li><li><strong>trigger</strong> — If set, a trigger with this name (or type) is created so other code can start the task via trigger.</li><li><strong>action</strong> — If set, an action is created that enqueues the task.</li><li><strong>service</strong> — Service name (default current service).</li></ul><h2 id="running-a-task" tabindex="-1"><a class="header-anchor" href="#running-a-task"><span>Running a task</span></a></h2><p>Use the <strong>task</strong> export from <code>@live-change/task-service</code>:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">import</span> task <span class="token keyword">from</span> <span class="token string">&#39;@live-change/task-service&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Then call <strong>task.run(taskDefinition, props, causeType, cause, expire?, client)</strong>. It will create or reuse a task (by hash of name + props + user/session), emit the create event if new, and run <strong>execute</strong>. Returns <strong>{ task, taskObject, promise, causeType, cause }</strong>.</p><p>Example (conceptual): from a trigger you call <code>task.run(myTaskDef, { id: &#39;x&#39; }, &#39;speedDating_Event&#39;, eventId, null, { user: client.user, session: client.session })</code>. Listen for task state triggers (e.g. taskCreated, taskDone, taskFailed) to react to completion.</p><h2 id="task-model-and-views" tabindex="-1"><a class="header-anchor" href="#task-model-and-views"><span>Task model and views</span></a></h2><p>Tasks are stored as <strong>Task</strong> with <strong>itemOfAny</strong> to <strong>cause</strong> (causeType, cause). Views include <strong>task</strong> (single), <strong>tasksByCauseAndHash</strong>, <strong>tasksByCauseAndState</strong>, <strong>tasksByCauseAndStart</strong>, etc. Use <strong>app.serviceViewGet(&#39;task&#39;, &#39;task&#39;, { task: id })</strong> or <strong>tasksByCauseAndState</strong> to observe progress.</p><h2 id="trigger-flow" tabindex="-1"><a class="header-anchor" href="#trigger-flow"><span>Trigger flow</span></a></h2><p>When a task is created, the framework emits triggers such as <strong>taskCreated</strong>, <strong>taskDone</strong>, <strong>taskFailed</strong>, and cause-specific triggers like <strong>&lt;causeType&gt;_&lt;cause&gt;OwnedTask&lt;TaskName&gt;&lt;State&gt;</strong> so other services can react (e.g. update UI or run follow-up logic).</p>`,16)]))}const l=e(r,[["render",i]]),p=JSON.parse('{"path":"/server/14-tasks.html","title":"Tasks","lang":"en-US","frontmatter":{"title":"Tasks"},"headers":[{"level":2,"title":"Dependencies","slug":"dependencies","link":"#dependencies","children":[]},{"level":2,"title":"Task definition","slug":"task-definition","link":"#task-definition","children":[]},{"level":2,"title":"Running a task","slug":"running-a-task","link":"#running-a-task","children":[]},{"level":2,"title":"Task model and views","slug":"task-model-and-views","link":"#task-model-and-views","children":[]},{"level":2,"title":"Trigger flow","slug":"trigger-flow","link":"#trigger-flow","children":[]}],"git":{"updatedTime":1771163669000,"contributors":[{"name":"Michał Łaszczewski","username":"","email":"michal@laszczewski.com","commits":1}],"changelog":[{"hash":"cfc969ff1ce8a43846182cb1c9818f3c88cd885a","time":1771163669000,"email":"michal@laszczewski.com","author":"Michał Łaszczewski","message":"docs"}]},"filePathRelative":"server/14-tasks.md"}');export{l as comp,p as data};
