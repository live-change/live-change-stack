import{_ as s,c as a,e as p,o as e}from"./app-CdUme-sL.js";const t={};function o(c,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h1 id="actions" tabindex="-1"><a class="header-anchor" href="#actions"><span>Actions</span></a></h1><p>Actions are defined with <strong>definition.action({ name, properties, returns, execute })</strong>. They run in a request context, can read <strong>client.user</strong> / <strong>client.session</strong>, call <strong>triggerService</strong> or <strong>trigger</strong> to invoke other services or triggers, and <strong>emit</strong> events to create or update model data.</p><h2 id="action-that-creates-an-entity-and-starts-payment-topup" tabindex="-1"><a class="header-anchor" href="#action-that-creates-an-entity-and-starts-payment-topup"><span>Action that creates an entity and starts payment (topUp)</span></a></h2><p>Validates input, ensures billing exists, emits a creation event, then triggers a payment flow:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: live-change-stack/services/billing-service/topUp.js (excerpt)</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;topUp&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">currency</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">returns</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Object <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> price<span class="token punctuation">,</span> currency<span class="token punctuation">,</span> cancelUrl<span class="token punctuation">,</span> successUrl <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> trigger<span class="token punctuation">,</span> triggerService<span class="token punctuation">,</span> client <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> offer <span class="token operator">=</span> config<span class="token punctuation">.</span>topUpOffers<span class="token operator">?.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">offer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>offer<span class="token punctuation">.</span>currency <span class="token operator">===</span> currency<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>offer<span class="token punctuation">.</span>price <span class="token operator">===</span> price<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>offer<span class="token punctuation">.</span>value <span class="token operator">===</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> anyTopUpPrice <span class="token operator">=</span> config<span class="token operator">?.</span>anyTopUpPrices<span class="token operator">?.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">price</span> <span class="token operator">=&gt;</span> price<span class="token punctuation">.</span>currency <span class="token operator">===</span> currency<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>offer <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>anyTopUpPrice<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid top up offer&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// ... validation ...</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> billing <span class="token operator">=</span> client<span class="token punctuation">.</span>user  <span class="token comment">// billing is user property</span></span>
<span class="line">    <span class="token keyword">const</span> billingData <span class="token operator">=</span> <span class="token keyword">await</span> Billing<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>billing<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>billingData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">service</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;billing_setOrUpdateBilling&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">user</span><span class="token operator">:</span> client<span class="token punctuation">.</span>user <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> topUp <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">generateUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;TopUpCreated&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      topUp<span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> price<span class="token punctuation">,</span> currency <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">identifiers</span><span class="token operator">:</span> <span class="token punctuation">{</span> billing <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> triggerResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;startPayment&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">causeType</span><span class="token operator">:</span> <span class="token string">&#39;billing_TopUp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cause</span><span class="token operator">:</span> topUp<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">payerType</span><span class="token operator">:</span> <span class="token string">&#39;user_User&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">payer</span><span class="token operator">:</span> client<span class="token punctuation">.</span>user<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Top Up &#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">price</span><span class="token operator">:</span> price<span class="token punctuation">,</span> <span class="token literal-property property">currency</span><span class="token operator">:</span> currency<span class="token punctuation">,</span> <span class="token literal-property property">quantity</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">successUrl</span><span class="token operator">:</span> config<span class="token punctuation">.</span>topUpSuccessUrl <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> topUp<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\[</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;(&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cancelUrl</span><span class="token operator">:</span> config<span class="token punctuation">.</span>topUpCancelUrl <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> topUp<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\[</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;(&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>triggerResult<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No payment service available&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> triggerResult</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="action-that-delegates-to-triggerservice-givecard" tabindex="-1"><a class="header-anchor" href="#action-that-delegates-to-triggerservice-givecard"><span>Action that delegates to triggerService (giveCard)</span></a></h2><p>Uses <strong>client.user</strong> or <strong>client.session</strong> to determine giver; creates a card via triggerService if it does not exist:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: speed-dating/server/business-card-service/card.js</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;giveCard&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">receiverType</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">validation</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;nonEmpty&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">receiver</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">validation</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;nonEmpty&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">givenInType</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;type&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">givenIn</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;any&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> receiverType<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> givenInType<span class="token punctuation">,</span> givenIn <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> service<span class="token punctuation">,</span> triggerService <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">[</span>giverType<span class="token punctuation">,</span> giver<span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token punctuation">.</span>user <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">&#39;user_User&#39;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>user<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;session_Session&#39;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>session<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">const</span> cardId <span class="token operator">=</span> App<span class="token punctuation">.</span><span class="token function">encodeIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">[</span>receiverType<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> giverType<span class="token punctuation">,</span> giver<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> card <span class="token operator">=</span> <span class="token keyword">await</span> ReceivedCard<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cardId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Card already given&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">service</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;businessCard_setReceivedCard&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">sessionOrUserType</span><span class="token operator">:</span> receiverType<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">sessionOrUser</span><span class="token operator">:</span> receiver<span class="token punctuation">,</span></span>
<span class="line">        giverType<span class="token punctuation">,</span></span>
<span class="line">        giver<span class="token punctuation">,</span></span>
<span class="line">        givenInType<span class="token punctuation">,</span></span>
<span class="line">        givenIn</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="context-and-helpers" tabindex="-1"><a class="header-anchor" href="#context-and-helpers"><span>Context and helpers</span></a></h2><ul><li><strong>execute(params, context, emit)</strong> — params come from the client; context includes <strong>client</strong> (user, session), <strong>triggerService</strong>, <strong>trigger</strong>, <strong>service</strong>.</li><li><strong>client.user</strong> — Set when the session is bound to a user.</li><li><strong>client.session</strong> — Current session id.</li><li><strong>triggerService({ service, type }, payload)</strong> — Invokes an action/command on another (or same) service.</li><li><strong>trigger({ type }, payload)</strong> — Fires a trigger (e.g. startPayment) that may be handled by another service.</li><li><strong>emit(event)</strong> — Appends an event to the event log (e.g. TopUpCreated); processors update model state.</li><li><strong>app.generateUid()</strong> — Generates a unique id for new entities.</li></ul>`,10)]))}const i=s(t,[["render",o]]),r=JSON.parse('{"path":"/server/06-actions.html","title":"Actions","lang":"en-US","frontmatter":{"title":"Actions"},"headers":[{"level":2,"title":"Action that creates an entity and starts payment (topUp)","slug":"action-that-creates-an-entity-and-starts-payment-topup","link":"#action-that-creates-an-entity-and-starts-payment-topup","children":[]},{"level":2,"title":"Action that delegates to triggerService (giveCard)","slug":"action-that-delegates-to-triggerservice-givecard","link":"#action-that-delegates-to-triggerservice-givecard","children":[]},{"level":2,"title":"Context and helpers","slug":"context-and-helpers","link":"#context-and-helpers","children":[]}],"git":{"updatedTime":1771163669000,"contributors":[{"name":"Michał Łaszczewski","username":"","email":"michal@laszczewski.com","commits":1}],"changelog":[{"hash":"cfc969ff1ce8a43846182cb1c9818f3c88cd885a","time":1771163669000,"email":"michal@laszczewski.com","author":"Michał Łaszczewski","message":"docs"}]},"filePathRelative":"server/06-actions.md"}');export{i as comp,r as data};
