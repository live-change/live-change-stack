import{_ as n,c as a,e,o as t}from"./app-CdUme-sL.js";const p={};function r(o,s){return t(),a("div",null,s[0]||(s[0]=[e(`<h1 id="timers" tabindex="-1"><a class="header-anchor" href="#timers"><span>Timers</span></a></h1><p>The <strong>timer service</strong> (<code>@live-change/timer-service</code>) runs a callback at a given time (one-shot or repeating). You call <strong>triggerService({ service: &#39;timer&#39;, type: &#39;createTimer&#39; }, { timer: { ... } })</strong> to schedule and <strong>cancelTimer</strong> / <strong>cancelTimerIfExists</strong> to cancel. No need to add timer to your service <strong>use</strong>; it is a standalone service you call via triggerService.</p><h2 id="createtimer" tabindex="-1"><a class="header-anchor" href="#createtimer"><span>createTimer</span></a></h2><p>Invoke via trigger (e.g. from your trigger or action):</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;timer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;createTimer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">timer</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> optionalId<span class="token punctuation">,</span>           <span class="token comment">// optional; generated if omitted</span></span>
<span class="line">    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> number<span class="token punctuation">,</span>       <span class="token comment">// Unix ms (use this or time)</span></span>
<span class="line">    <span class="token literal-property property">time</span><span class="token operator">:</span> Date<span class="token punctuation">,</span>              <span class="token comment">// or Date object</span></span>
<span class="line">    <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;yourService&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// service that will receive the trigger</span></span>
<span class="line">    <span class="token literal-property property">trigger</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;yourTriggerName&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">event</span><span class="token operator">:</span> eventId <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">loops</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token comment">// 0 = one-shot, &gt;0 = repeat</span></span>
<span class="line">    <span class="token literal-property property">interval</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment">// ms between repeats (required if loops &gt; 0)</span></span>
<span class="line">    <span class="token literal-property property">maxRetries</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">retryDelay</span><span class="token operator">:</span> <span class="token number">5000</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The timer service stores the timer and, at the given time, runs <strong>triggerService({ ...timer.trigger, service: timer.service }, timer.trigger.data)</strong> (or <strong>app.trigger</strong> if no service). Returns <strong>timerId</strong>.</p><h2 id="canceltimer-canceltimerifexists" tabindex="-1"><a class="header-anchor" href="#canceltimer-canceltimerifexists"><span>cancelTimer / cancelTimerIfExists</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;timer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;cancelTimer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timer</span><span class="token operator">:</span> timerId <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;timer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;cancelTimerIfExists&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timer</span><span class="token operator">:</span> timerId <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>cancelTimer</strong> throws if the timer does not exist; <strong>cancelTimerIfExists</strong> returns false and does not throw.</p><h2 id="example-schedule-event-start-speed-dating" tabindex="-1"><a class="header-anchor" href="#example-schedule-event-start-speed-dating"><span>Example: schedule event start (speed-dating)</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: speed-dating/server/speed-dating-service/event.js</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">changeSpeedDating_Event</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">object</span><span class="token operator">:</span> eventId<span class="token punctuation">,</span> data<span class="token punctuation">,</span> oldData <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> service<span class="token punctuation">,</span> triggerService <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> startTime <span class="token operator">=</span> data<span class="token operator">?.</span>startTime</span>
<span class="line">    <span class="token keyword">const</span> autoStart <span class="token operator">=</span> data<span class="token operator">?.</span>autoStart</span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>startTime <span class="token operator">||</span> <span class="token operator">!</span>autoStart<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;timer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;cancelTimerIfExists&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timer</span><span class="token operator">:</span> eventId <span class="token operator">+</span> <span class="token string">&#39;_start&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> timer <span class="token operator">=</span> eventId <span class="token operator">+</span> <span class="token string">&#39;_start&#39;</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;timer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;cancelTimerIfExists&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> timer <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;timer&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;createTimer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">timer</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">id</span><span class="token operator">:</span> timer<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">time</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;speedDating&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">trigger</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;startSpeedDatingEvent&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">event</span><span class="token operator">:</span> eventId <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When the timer fires, the timer service calls <strong>triggerService({ type: &#39;startSpeedDatingEvent&#39;, service: &#39;speedDating&#39; }, { event: eventId })</strong>, which your <strong>startSpeedDatingEvent</strong> trigger handles.</p><h2 id="loops-and-interval" tabindex="-1"><a class="header-anchor" href="#loops-and-interval"><span>Loops and interval</span></a></h2><ul><li><strong>loops: 0</strong> — Fire once.</li><li><strong>loops &gt; 0</strong> and <strong>interval</strong> (ms) — Repeating; after each fire the next run is at <strong>timestamp + interval</strong> until loops are exhausted. The service emits <strong>timerFired</strong> and updates the stored timer; when loops reach 0 it emits <strong>timerFinished</strong> and removes the timer.</li></ul><h2 id="failure-and-retries" tabindex="-1"><a class="header-anchor" href="#failure-and-retries"><span>Failure and retries</span></a></h2><p>If the trigger call fails, the timer service can retry: <strong>maxRetries</strong> and <strong>retryDelay</strong> (ms). After <strong>timerFailed</strong> it reschedules at <strong>now + retryDelay</strong>; after max retries it emits <strong>timerFinished</strong> with error and removes the timer.</p>`,16)]))}const l=n(p,[["render",r]]),c=JSON.parse('{"path":"/server/16-timers.html","title":"Timers","lang":"en-US","frontmatter":{"title":"Timers"},"headers":[{"level":2,"title":"createTimer","slug":"createtimer","link":"#createtimer","children":[]},{"level":2,"title":"cancelTimer / cancelTimerIfExists","slug":"canceltimer-canceltimerifexists","link":"#canceltimer-canceltimerifexists","children":[]},{"level":2,"title":"Example: schedule event start (speed-dating)","slug":"example-schedule-event-start-speed-dating","link":"#example-schedule-event-start-speed-dating","children":[]},{"level":2,"title":"Loops and interval","slug":"loops-and-interval","link":"#loops-and-interval","children":[]},{"level":2,"title":"Failure and retries","slug":"failure-and-retries","link":"#failure-and-retries","children":[]}],"git":{"updatedTime":1771163669000,"contributors":[{"name":"Michał Łaszczewski","username":"","email":"michal@laszczewski.com","commits":1}],"changelog":[{"hash":"cfc969ff1ce8a43846182cb1c9818f3c88cd885a","time":1771163669000,"email":"michal@laszczewski.com","author":"Michał Łaszczewski","message":"docs"}]},"filePathRelative":"server/16-timers.md"}');export{l as comp,c as data};
