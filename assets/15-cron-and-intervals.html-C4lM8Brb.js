import{_ as s,c as e,e as a,o as t}from"./app-CdUme-sL.js";const r={};function o(i,n){return t(),e("div",null,n[0]||(n[0]=[a(`<h1 id="cron-and-intervals" tabindex="-1"><a class="header-anchor" href="#cron-and-intervals"><span>Cron and intervals</span></a></h1><p>The <strong>cron service</strong> (<code>@live-change/cron-service</code>) runs code at fixed times (<strong>Schedule</strong> — cron-like) or on a fixed interval (<strong>Interval</strong>). It uses the <strong>task service</strong> to execute triggers; you configure which <strong>trigger</strong> (service + name + properties) to run. Add <strong>cron</strong> (and <strong>task</strong>) to your app config and <strong>cronService</strong> to <strong>use</strong> when defining triggers that cron will call.</p><h2 id="dependencies" tabindex="-1"><a class="header-anchor" href="#dependencies"><span>Dependencies</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: live-change-stack/services/cron-service/definition.js</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> taskService <span class="token keyword">from</span> <span class="token string">&#39;@live-change/task-service&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> definition <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createServiceDefinition</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;cron&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span> relationsPlugin<span class="token punctuation">,</span> accessControlService<span class="token punctuation">,</span> taskService <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="schedule-cron-like" tabindex="-1"><a class="header-anchor" href="#schedule-cron-like"><span>Schedule (cron-like)</span></a></h2><p><strong>Schedule</strong> is a <strong>propertyOfAny</strong> with <strong>owner</strong> and <strong>topic</strong>. Properties include:</p><ul><li><strong>minute</strong>, <strong>hour</strong>, <strong>day</strong>, <strong>dayOfWeek</strong> — Numbers or NaN for “every” (e.g. NaN for minute = every minute).</li><li><strong>trigger</strong> — Object: <strong>name</strong>, <strong>service</strong>, <strong>properties</strong>, <strong>returnTask</strong>. When the schedule fires, the cron service calls <strong>triggerService({ type: trigger.name, service: trigger.service, causeType: &#39;cron_Schedule&#39;, cause: scheduleId }, { ...trigger.properties })</strong>. If <strong>returnTask</strong> is true, the run waits for the task.</li></ul><p>Access is controlled by <strong>ownerTypes</strong> / <strong>topicTypes</strong> and <strong>writeAccessControl</strong> / <strong>readAccessControl</strong> (e.g. admin roles).</p><h2 id="interval-repeating-delay" tabindex="-1"><a class="header-anchor" href="#interval-repeating-delay"><span>Interval (repeating delay)</span></a></h2><p><strong>Interval</strong> is a <strong>propertyOfAny</strong> with <strong>owner</strong> and <strong>topic</strong>. Properties include:</p><ul><li><strong>interval</strong> — Milliseconds between runs.</li><li><strong>firstRunDelay</strong> — Optional delay before first run.</li><li><strong>wait</strong> — If set, wait for the previous run to finish before scheduling the next.</li><li><strong>trigger</strong> — Same shape as Schedule (name, service, properties, returnTask).</li></ul><p><strong>IntervalInfo</strong> (propertyOf Interval) stores <strong>lastRun</strong> and <strong>nextRun</strong> for each interval.</p><h2 id="run-and-runstate" tabindex="-1"><a class="header-anchor" href="#run-and-runstate"><span>Run and RunState</span></a></h2><p>When a schedule or interval fires, the service creates a <strong>RunState</strong> (propertyOfAny to <strong>job</strong>, jobTypes: <code>[&#39;cron_Interval&#39;, &#39;cron_Schedule&#39;]</code>) with state <strong>running</strong> or <strong>waiting</strong>, and optionally a <strong>tasks</strong> array (task service tasks). <strong>doRunTrigger(triggerInfo, context)</strong> runs <strong>triggerService</strong> with the trigger name and service; if <strong>returnTask</strong> is true, the run can wait for the task to complete.</p><h2 id="config" tabindex="-1"><a class="header-anchor" href="#config"><span>Config</span></a></h2><p><strong>config.js</strong> (or definition.config) can set <strong>adminRoles</strong>, <strong>readerRoles</strong>, <strong>ownerTypes</strong>, <strong>topicTypes</strong> to control who can create/edit schedules and intervals and who can read them.</p><h2 id="defining-a-trigger-that-cron-can-call" tabindex="-1"><a class="header-anchor" href="#defining-a-trigger-that-cron-can-call"><span>Defining a trigger that cron can call</span></a></h2><p>In your service, define a <strong>trigger</strong> that the cron job will invoke:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">definition<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;myScheduledJob&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> triggerService<span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// run your logic</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Then create a Schedule or Interval (via cron service actions/views) with <strong>trigger: { name: &#39;myScheduledJob&#39;, service: &#39;yourService&#39;, properties: { ... }, returnTask: false }</strong>. The cron worker will call this trigger at the configured times or intervals.</p>`,20)]))}const l=s(r,[["render",o]]),p=JSON.parse('{"path":"/server/15-cron-and-intervals.html","title":"Cron and intervals","lang":"en-US","frontmatter":{"title":"Cron and intervals"},"headers":[{"level":2,"title":"Dependencies","slug":"dependencies","link":"#dependencies","children":[]},{"level":2,"title":"Schedule (cron-like)","slug":"schedule-cron-like","link":"#schedule-cron-like","children":[]},{"level":2,"title":"Interval (repeating delay)","slug":"interval-repeating-delay","link":"#interval-repeating-delay","children":[]},{"level":2,"title":"Run and RunState","slug":"run-and-runstate","link":"#run-and-runstate","children":[]},{"level":2,"title":"Config","slug":"config","link":"#config","children":[]},{"level":2,"title":"Defining a trigger that cron can call","slug":"defining-a-trigger-that-cron-can-call","link":"#defining-a-trigger-that-cron-can-call","children":[]}],"git":{"updatedTime":1771163669000,"contributors":[{"name":"Michał Łaszczewski","username":"","email":"michal@laszczewski.com","commits":1}],"changelog":[{"hash":"cfc969ff1ce8a43846182cb1c9818f3c88cd885a","time":1771163669000,"email":"michal@laszczewski.com","author":"Michał Łaszczewski","message":"docs"}]},"filePathRelative":"server/15-cron-and-intervals.md"}');export{l as comp,p as data};
