import{_ as s,c as a,e as p,o as e}from"./app-CdUme-sL.js";const t={};function o(l,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h1 id="triggers" tabindex="-1"><a class="header-anchor" href="#triggers"><span>Triggers</span></a></h1><p>Triggers are defined with <strong>definition.trigger({ name, properties, execute })</strong>. They run when matching events occur (either in the same service or from another service). They are used to keep cross-service state in sync (e.g. create a balance when Billing is created, or update TopUp state when payment completes).</p><h2 id="trigger-on-model-creation-createbilling-billing" tabindex="-1"><a class="header-anchor" href="#trigger-on-model-creation-createbilling-billing"><span>Trigger on model creation (createBilling_Billing)</span></a></h2><p>When a Billing entity is created, ensure a balance exists for that owner:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: live-change-stack/services/billing-service/billing.js</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;createBilling_Billing&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">object</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Billing <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> object <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> triggerService <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> ownerInfo <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">ownerType</span><span class="token operator">:</span> <span class="token string">&#39;billing_Billing&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">owner</span><span class="token operator">:</span> object <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> existingBalance <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">serviceViewGet</span><span class="token punctuation">(</span><span class="token string">&#39;balance&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;balance&#39;</span><span class="token punctuation">,</span> ownerInfo<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>existingBalance<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">&#39;balance&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;balance_setOrUpdateBalance&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> ownerInfo<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="trigger-on-external-payment-event-chargecollected-billing-topup" tabindex="-1"><a class="header-anchor" href="#trigger-on-external-payment-event-chargecollected-billing-topup"><span>Trigger on external payment event (chargeCollected_billing_TopUp)</span></a></h2><p>When a payment service emits that a charge was collected for a billing TopUp, credit the balance and update TopUp state:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: live-change-stack/services/billing-service/topUp.js</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;chargeCollected_billing_TopUp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">paymentType</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">payment</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">causeType</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">cause</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">payerType</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">payer</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> triggerService<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> paymentType<span class="token punctuation">,</span> payment<span class="token punctuation">,</span> causeType<span class="token punctuation">,</span> cause<span class="token punctuation">,</span> payerType<span class="token punctuation">,</span> payer<span class="token punctuation">,</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> props</span>
<span class="line">    <span class="token keyword">const</span> topUp <span class="token operator">=</span> <span class="token keyword">await</span> TopUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>topUp<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;TopUp not found&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>topUp<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token string">&#39;created&#39;</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;TopUp already processed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> balance <span class="token operator">=</span> App<span class="token punctuation">.</span><span class="token function">encodeIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;billing_Billing&#39;</span><span class="token punctuation">,</span> topUp<span class="token punctuation">.</span>billing<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;balance_doOperation&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      balance<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">causeType</span><span class="token operator">:</span> <span class="token string">&#39;billing_TopUp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cause</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">change</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>value</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">service</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;billing_updateTopUp&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">billing</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>billing<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">topUp</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&#39;paid&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="trigger-on-refund-and-payment-failure" tabindex="-1"><a class="header-anchor" href="#trigger-on-refund-and-payment-failure"><span>Trigger on refund and payment failure</span></a></h2><p>Same event shape, different handling: refund decrements balance and sets state to &#39;refunded&#39;; payment failed only updates state to &#39;failed&#39;:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Source: live-change-stack/services/billing-service/topUp.js (excerpts)</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;chargeRefunded_billing_TopUp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span> paymentType<span class="token punctuation">,</span> payment<span class="token punctuation">,</span> causeType<span class="token punctuation">,</span> cause<span class="token punctuation">,</span> payerType<span class="token punctuation">,</span> payer<span class="token punctuation">,</span> items <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> triggerService<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> causeType<span class="token punctuation">,</span> cause <span class="token punctuation">}</span> <span class="token operator">=</span> props</span>
<span class="line">    <span class="token keyword">const</span> topUp <span class="token operator">=</span> <span class="token keyword">await</span> TopUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>topUp <span class="token operator">||</span> topUp<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token string">&#39;paid&#39;</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Impossible to refund not paid top up&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> balance <span class="token operator">=</span> App<span class="token punctuation">.</span><span class="token function">encodeIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;billing_Billing&#39;</span><span class="token punctuation">,</span> topUp<span class="token punctuation">.</span>billing<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;balance_doOperation&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">billing</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>billing<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">causeType</span><span class="token operator">:</span> <span class="token string">&#39;billing_TopUp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cause</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">change</span><span class="token operator">:</span> <span class="token operator">-</span>topUp<span class="token punctuation">.</span>value<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">service</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;billing_updateTopUp&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">topUp</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&#39;refunded&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">definition<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;paymentFailed_billing_TopUp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> triggerService <span class="token punctuation">}</span><span class="token punctuation">,</span> emit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> topUp <span class="token operator">=</span> <span class="token keyword">await</span> TopUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>cause<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>topUp <span class="token operator">||</span> topUp<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token string">&#39;created&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">triggerService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">service</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;billing_updateTopUp&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">billing</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>billing<span class="token punctuation">,</span> <span class="token literal-property property">topUp</span><span class="token operator">:</span> topUp<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&#39;failed&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="naming-and-routing" tabindex="-1"><a class="header-anchor" href="#naming-and-routing"><span>Naming and routing</span></a></h2><p>Trigger <strong>names</strong> typically follow the pattern <strong>eventName_serviceName_ModelName</strong> (e.g. <code>chargeCollected_billing_TopUp</code>). The framework routes events from other services to triggers whose name matches. <strong>triggerService</strong> calls an action/command on a service; <strong>trigger</strong> invokes a trigger by type (e.g. balance_doOperation) that may be implemented by another service.</p>`,13)]))}const i=s(t,[["render",o]]),r=JSON.parse('{"path":"/server/08-triggers.html","title":"Triggers","lang":"en-US","frontmatter":{"title":"Triggers"},"headers":[{"level":2,"title":"Trigger on model creation (createBilling_Billing)","slug":"trigger-on-model-creation-createbilling-billing","link":"#trigger-on-model-creation-createbilling-billing","children":[]},{"level":2,"title":"Trigger on external payment event (chargeCollected_billing_TopUp)","slug":"trigger-on-external-payment-event-chargecollected-billing-topup","link":"#trigger-on-external-payment-event-chargecollected-billing-topup","children":[]},{"level":2,"title":"Trigger on refund and payment failure","slug":"trigger-on-refund-and-payment-failure","link":"#trigger-on-refund-and-payment-failure","children":[]},{"level":2,"title":"Naming and routing","slug":"naming-and-routing","link":"#naming-and-routing","children":[]}],"git":{"updatedTime":1771163669000,"contributors":[{"name":"Michał Łaszczewski","username":"","email":"michal@laszczewski.com","commits":1}],"changelog":[{"hash":"cfc969ff1ce8a43846182cb1c9818f3c88cd885a","time":1771163669000,"email":"michal@laszczewski.com","author":"Michał Łaszczewski","message":"docs"}]},"filePathRelative":"server/08-triggers.md"}');export{i as comp,r as data};
